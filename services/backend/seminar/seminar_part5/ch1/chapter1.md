- 애플리케이션 보안은 허가되지 않은 개체가 애플리케이션을 해킹하거나  
  불법적으로 변경하는 것을 방지하기 위해 애플리케이션에 대한 접근을 제한하는 것을 말한다.

  | 인증과 허가          | 설명                                                                |
  | -------------------- | ------------------------------------------------------------------- |
  | 인증(authentication) | 개체가 전달한 정보를 검증하는 것. 일반적으로 아이디와 비밀번호 사용 |
  | 허가(authorization)  | 인증된 개체에게 특정 처리를 할 수 있도록 권한을 주는 것             |

- Part5 의 목표  
  - hash를 사용해 패스워드를 보호하고 FastAPI 애플리케이션에 인증 계층을 추가할 수 있다. 
  - 허가되지 않은 사용자로부터 라우트를 보호할 수 있다.

<br/>

#### 1.1 FastAPI의 주요 인증 방식
- 기본 HTTP 인증  
  - HTTPBasic클래스를 사용하여 구현 가능
  - Authorization헤더에 아이디와 비밀번호를 Base64로 인코딩하여 전송하면 서버는 이를 받아서 디코딩 한 후 인증여부를 결정하는 방법. 간단하게 구현 가능하지만 보안성이 떨어진다.

<br/>

- 쿠키 (Cookie)
  - 쿠키를 이용한 인증은 아래와 같이 이루어진다.
    1. 클라이언트가 로그인을 시도하면 서버는 요청한 로그인 정보를 검증하고 검증이 성공하면 세션ID를 생성
     
    2. 서버는 생성한 세션ID와 쿠키만료날짜 등의 값을 설정하여 응답의 "Set-Cookie" 헤더에 추가하여 클라이언트에게 전송
  
    3. 클라이언트는 이후 요청을 보낼 때 이전 응답에서 받은 쿠키정보를 "Cookie"헤더에  포함하여 서버에 전송
     
    4. 서버는 전송받은 요청의 쿠키값에 포함된 세션ID, 만료일 등을 서버에 저장한 값과 비교하여 인증 및 접근 권한 여부를 판단

<br/>

- bearer 토큰 인증
  - 클라이언트가 서버에 요청을 보낼 때 Authorization헤더에 토큰을 함께 전송하여 인증을 수행하는 방식
  - bearer 토큰 인증의 동작은 아래와 같이 이루어진다.
  
    1. 클라이언트가 로그인을 시도하면 서버는 아이디와 비밀번호를 검증하고 검증이 성공하면 액세스 토큰을 생성하여 클라이언트에게 전달한다.
    
    2. 클라이언트는 이후 요청에서 Authorization헤더에 Bearer와 액세스 토큰을 포함하여 요청한다.

    3. 서버는 전송받은 액세스 토큰을 검증하여 인증을 수행한다. 검증은 토큰의 유효성, 만료여부, 서명 검증 등을 포함할 수 있다.

<br/>

#### 1.2 의존성 주입
- 객체(함수)가 실행에 필요한 인스턴스 변수를 받는 방식
- FastAPI에서는 라우트 처리 함수의 인수로 의존 라이브러리를 주입한다.

```python
@user_router.post("/signup")
async def sign_new_user(new_user: User) -> dict:
    select_user_exist = select(User).where(User.email == new_user.email)
```
여기서 User 클래스가 의존 라이브러리이며 이를 sign_new_user()함수에 주입한다.
User를 사용자함수의 인수로 주입해 User객체의 인스턴스인 new_user를 생성하였으며 이를 통해 User 클래스의 속성을 쉽게 추출할 수 있다.

<br/>

#### 1.3 의존 라이브러리 생성
- FastAPI에서 의존 라이브러리는 함수 또는 클래스로 정의된다.
- 생성된 의존 라이브러리는 기본값과 메서드에 접근할 수 있으므로 함수 내에서 이러한 객체를 상속하지 않아도 된다.
- 의존성 주입은 반복된 코드 작성을 줄여주므로 인증과 허가처럼 반복적인 구현이 필요한 경우에 큰 도움이 됨  
  
다음과 같이 의존 라이브러리를 정의하고 사용할 수 있다.

###### 의존 라이브러리 정의
```python
async def get_user(token: str):
    user = decode_token(token)
    return user
```

###### 의존 라이브러리 사용
```python
from fastapi import Depends

@router.get("/user/me")
async get_user_details(user: User = Depends(get_user)):
  return user
```

- 이 라우트 함수는 get_user라는 함수에 의존한다.
- Depends 클래스는 라우트가 실행될 때 인수로 받은 함수(get_user)를 실행하고 함수의 반환값을 라우트에 전달한다.